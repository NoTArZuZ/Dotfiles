#!/usr/bin/env bash

source ~/.config/qtile/vars
source ~/.config/qtile/curtheme

set -euo pipefail

# this thing gonna be MASSIVE
# for now qtile, helix, xresources (gtk and qt through home-manager) is supported

lowcasetheme() {
  lowcasechoose=$(echo $choose2 | tr '[:upper:]' '[:lower:]')
  if [ $CURTHEME == "CatppuccinMocha" ]; then
    lowcasecurtheme="catppuccin_mocha"
  elif [ $CURTHEME = "RosePine" ]; then
    lowcasecurtheme="rose_pine"
  elif [ $CURTHEME = "Wal" ]; then
    lowcasecurtheme="base16_transparent"
  else
    lowcasecurtheme=$(echo $CURTHEME | tr '[:upper:]' '[:lower:]')
  fi
}

helixtheming() {
  if [ $choose2 == "CatppuccinMocha" ]; then
    sed -i "s/$lowcasecurtheme/catppuccin_mocha/" $HOME/Dotfiles/.config/helix/config.toml
  elif [ $choose2 == "RosePine" ]; then
    sed -i "s/$lowcasecurtheme/rose_pine/" $HOME/Dotfiles/.config/helix/config.toml
  elif [ $choose2 == "Wal" ]; then
    sed -i "s/$lowcasecurtheme/base16_transparent/" $HOME/Dotfiles/.config/helix/config.toml
  else
    sed -i "s/$lowcasecurtheme/$lowcasechoose/" $HOME/Dotfiles/.config/helix/config.toml
  fi
}

restoretheme() {
  if [ $CURTHEME == "Wal" ]; then
    wallust run ~/.cache/wallcache
    xrdb -merge ~/.cache/colors-xresources
  else
    xrdb -merge ~/.config/wallust/extrathemes/xres-$CURTHEME
  fi
}

while test $# -gt 0; do
  case "$1" in
    -r)
      restoretheme
      exit 0
    ;;
    *)
      printf "[-r] - restore theme\n"
      exit 1
    ;;
  esac
done

choose2=$(printf "$themes" | $menu "Choose:" -R -l $(printf "$themes\n" | wc -l))
if [ $choose2 == "Wal" ]; then
  sed -i "s/^colors = colors.*/colors = colors.$choose2/g" $HOME/Dotfiles/.config/qtile/config.py
  lowcasetheme
  helixtheming
  sed -i "s/$CURTHEME/$choose2/" $HOME/Dotfiles/.config/qtile/curtheme
  pkexec nixos-rebuild switch --flake $HOME/Dotfiles/nix-cfg/ --impure
  qtile cmd-obj -o cmd -f reload_config && $HOME/.config/qtile/autostart.sh
  kill -s USR1 $(pidof st)
  notify-send "Theme Tool" "Changed Theme to Wallust"
fi
sed -i "s/^colors = colors.*/colors = colors.$choose2/g" $HOME/Dotfiles/.config/qtile/config.py
lowcasetheme
helixtheming
cp ~/.config/wallust/extrathemes/home-"$choose2".nix $HOME/Dotfiles/nix-cfg/home.nix
sed -i "s/$CURTHEME/$choose2/" $HOME/Dotfiles/.config/qtile/curtheme
pkexec nixos-rebuild switch --flake $HOME/Dotfiles/nix-cfg/ --impure
qtile cmd-obj -o cmd -f reload_config && $HOME/.config/qtile/autostart.sh
kill -s USR1 $(pidof st)
notify-send "Theme Tool" "Changed Theme to $choose2"
